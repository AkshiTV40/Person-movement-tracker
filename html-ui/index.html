<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Person Movement Tracker</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        header {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .header-content {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .logo {
            width: 48px;
            height: 48px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 24px;
            font-weight: bold;
        }

        .header-text h1 {
            font-size: 24px;
            color: #333;
            margin: 0;
        }

        .header-text p {
            font-size: 14px;
            color: #666;
            margin: 0;
        }

        .status-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            background: #f5f5f5;
            border-radius: 8px;
            font-size: 14px;
            color: #666;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #999;
            animation: pulse 2s infinite;
        }

        .status-dot.active {
            background: #22c55e;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .main-grid {
            display: grid;
            grid-template-columns: 1fr 350px;
            gap: 20px;
            margin-bottom: 20px;
        }

        .video-section {
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .video-container {
            position: relative;
            background: #000;
            aspect-ratio: 16/9;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }

        #videoCanvas {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }

        .loading-spinner {
            display: none;
            position: absolute;
            width: 40px;
            height: 40px;
            border: 3px solid #ddd;
            border-top-color: #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        .loading-spinner.active {
            display: block;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .video-info {
            padding: 15px;
            border-top: 1px solid #eee;
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
        }

        .info-item {
            text-align: center;
        }

        .info-label {
            font-size: 12px;
            color: #999;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .info-value {
            font-size: 18px;
            font-weight: bold;
            color: #333;
            margin-top: 5px;
        }

        .sidebar {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .card h3 {
            font-size: 16px;
            font-weight: 600;
            color: #333;
            margin-bottom: 15px;
        }

        .control-group {
            margin-bottom: 15px;
        }

        .control-group:last-child {
            margin-bottom: 0;
        }

        .control-group label {
            display: block;
            font-size: 13px;
            font-weight: 500;
            color: #555;
            margin-bottom: 8px;
        }

        select, input[type="file"] {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 13px;
            color: #333;
            background: white;
            cursor: pointer;
            transition: border-color 0.2s;
        }

        select:hover, select:focus {
            border-color: #667eea;
            outline: none;
        }

        .button-group {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .btn {
            flex: 1;
            padding: 10px 16px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            white-space: nowrap;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: white;
            color: #667eea;
            border: 2px solid #667eea;
        }

        .btn-secondary:hover:not(:disabled) {
            background: #667eea;
            color: white;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .tracks-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .track-item {
            padding: 10px;
            background: #f9f9f9;
            border-left: 3px solid #667eea;
            margin-bottom: 8px;
            border-radius: 4px;
            font-size: 13px;
        }

        .track-item-id {
            font-weight: 600;
            color: #333;
        }

        .track-item-info {
            color: #666;
            font-size: 12px;
            margin-top: 4px;
        }

        .empty-message {
            text-align: center;
            color: #999;
            padding: 20px 10px;
            font-size: 13px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 15px;
        }

        .stat-box {
            background: linear-gradient(135deg, #667eea15, #764ba215);
            padding: 12px;
            border-radius: 8px;
            border-left: 3px solid #667eea;
        }

        .stat-label {
            font-size: 11px;
            color: #999;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .stat-value {
            font-size: 16px;
            font-weight: bold;
            color: #333;
            margin-top: 4px;
        }

        .alert {
            padding: 12px;
            border-radius: 6px;
            font-size: 13px;
            margin-bottom: 10px;
            display: none;
        }

        .alert.show {
            display: block;
        }

        .alert-error {
            background: #fee;
            color: #c33;
            border: 1px solid #fcc;
        }

        .alert-success {
            background: #efe;
            color: #3c3;
            border: 1px solid #cfc;
        }

        @media (max-width: 768px) {
            .main-grid {
                grid-template-columns: 1fr;
            }

            header {
                flex-direction: column;
                align-items: flex-start;
                gap: 15px;
            }

            .video-info {
                grid-template-columns: 1fr;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="header-content">
                <div class="logo">üëÅÔ∏è</div>
                <div class="header-text">
                    <h1>Person Movement Tracker</h1>
                    <p>Real-time detection and tracking</p>
                </div>
            </div>
            <div class="status-indicator">
                <div class="status-dot" id="statusDot"></div>
                <span id="statusText">Camera Inactive</span>
            </div>
        </header>

        <div class="main-grid">
            <!-- Main Video Section -->
            <div class="video-section">
                <div class="video-container">
                    <canvas id="videoCanvas"></canvas>
                    <div class="loading-spinner" id="loadingSpinner"></div>
                </div>
                <div class="video-info">
                    <div class="info-item">
                        <div class="info-label">Persons Detected</div>
                        <div class="info-value" id="detectionCount">0</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Inference Time</div>
                        <div class="info-value" id="inferenceTime">0ms</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">FPS</div>
                        <div class="info-value" id="fps">0</div>
                    </div>
                </div>
            </div>

            <!-- Sidebar Controls -->
            <div class="sidebar">
                <!-- Controls Card -->
                <div class="card">
                    <h3>Controls</h3>
                    
                    <div id="alertContainer"></div>

                    <div class="control-group">
                        <label for="modelSelect">Detection Model</label>
                        <select id="modelSelect">
                            <option value="yolov8">YOLOv8 (Fast)</option>
                            <option value="detr">DETR (Accurate)</option>
                            <option value="yolos">YOLOS (Balanced)</option>
                        </select>
                    </div>

                    <div class="control-group">
                        <label for="trackingToggle">
                            <input type="checkbox" id="trackingToggle" checked style="margin-right: 6px;">
                            Enable Tracking
                        </label>
                    </div>

                    <div class="button-group">
                        <button class="btn btn-primary" id="startBtn" onclick="startTracking()">Start</button>
                        <button class="btn btn-secondary" id="stopBtn" onclick="stopTracking()" disabled>Stop</button>
                    </div>

                    <div class="control-group">
                        <label for="fileInput">Upload Image</label>
                        <input type="file" id="fileInput" accept="image/*" onchange="handleFileUpload()">
                    </div>
                </div>

                <!-- Statistics Card -->
                <div class="card">
                    <h3>Performance</h3>
                    <div class="stats-grid">
                        <div class="stat-box">
                            <div class="stat-label">Active Tracks</div>
                            <div class="stat-value" id="activeTrackCount">0</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-label">Total Frames</div>
                            <div class="stat-value" id="frameCount">0</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-label">Avg Inference</div>
                            <div class="stat-value" id="avgInference">0ms</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-label">Status</div>
                            <div class="stat-value" id="connectionStatus">Idle</div>
                        </div>
                    </div>
                </div>

                <!-- Tracks Card -->
                <div class="card">
                    <h3>Active Tracks</h3>
                    <div class="tracks-list" id="tracksList">
                        <div class="empty-message">No active tracks</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_URL = 'http://localhost:8000';
        
        // State
        let state = {
            isTracking: false,
            sessionId: generateSessionId(),
            frameCount: 0,
            tracks: [],
            inferenceTime: 0,
            lastFrameTime: 0,
            fps: 0,
            cameraStream: null,
            videoElement: null,
            canvasElement: document.getElementById('videoCanvas'),
            canvasContext: null
        };

        // Initialize canvas context
        state.canvasContext = state.canvasElement.getContext('2d');

        function generateSessionId() {
            return 'session_' + Math.random().toString(36).substr(2, 9) + '_' + Date.now();
        }

        function showAlert(message, type = 'error') {
            const alertContainer = document.getElementById('alertContainer');
            const alert = document.createElement('div');
            alert.className = `alert alert-${type} show`;
            alert.textContent = message;
            alertContainer.innerHTML = '';
            alertContainer.appendChild(alert);

            setTimeout(() => {
                alert.classList.remove('show');
            }, 5000);
        }

        async function startTracking() {
            try {
                // Request camera permission
                const stream = await navigator.mediaDevices.getUserMedia({
                    video: { facingMode: 'user', width: { ideal: 1280 }, height: { ideal: 720 } }
                });

                state.cameraStream = stream;
                state.isTracking = true;

                // Create video element for stream
                state.videoElement = document.createElement('video');
                state.videoElement.srcObject = stream;
                state.videoElement.play();

                // Update UI
                document.getElementById('startBtn').disabled = true;
                document.getElementById('stopBtn').disabled = false;
                document.getElementById('statusDot').classList.add('active');
                document.getElementById('statusText').textContent = 'Camera Active';

                // Start processing frames
                processFrame();
            } catch (error) {
                console.error('Error accessing camera:', error);
                showAlert('Failed to access camera. Please check permissions.');
            }
        }

        function stopTracking() {
            state.isTracking = false;

            // Stop camera stream
            if (state.cameraStream) {
                state.cameraStream.getTracks().forEach(track => track.stop());
            }

            // Update UI
            document.getElementById('startBtn').disabled = false;
            document.getElementById('stopBtn').disabled = true;
            document.getElementById('statusDot').classList.remove('active');
            document.getElementById('statusText').textContent = 'Camera Inactive';

            // Clear canvas
            state.canvasContext.fillStyle = '#000';
            state.canvasContext.fillRect(0, 0, state.canvasElement.width, state.canvasElement.height);

            document.getElementById('connectionStatus').textContent = 'Idle';
        }

        async function processFrame() {
            if (!state.isTracking || !state.videoElement) return;

            try {
                // Set canvas size to match video
                if (state.videoElement.videoWidth && state.videoElement.videoHeight) {
                    state.canvasElement.width = state.videoElement.videoWidth;
                    state.canvasElement.height = state.videoElement.videoHeight;

                    // Draw video frame
                    state.canvasContext.drawImage(state.videoElement, 0, 0);

                    // Get frame data
                    const imageData = state.canvasElement.toDataURL('image/jpeg', 0.9);

                    // Send to backend
                    const response = await fetch(`${API_URL}/api/track`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            image: imageData,
                            session_id: state.sessionId,
                            model_type: document.getElementById('modelSelect').value,
                            enable_tracking: document.getElementById('trackingToggle').checked
                        })
                    });

                    if (response.ok) {
                        const result = await response.json();

                        // Update stats
                        state.frameCount++;
                        state.inferenceTime = result.inference_time || 0;
                        state.tracks = result.detections || [];

                        // Calculate FPS
                        const now = Date.now();
                        if (state.lastFrameTime) {
                            state.fps = Math.round(1000 / (now - state.lastFrameTime));
                        }
                        state.lastFrameTime = now;

                        // Display processed image
                        if (result.image) {
                            const img = new Image();
                            img.onload = () => {
                                state.canvasContext.drawImage(img, 0, 0);
                            };
                            img.src = 'data:image/jpeg;base64,' + result.image;
                        }

                        // Update UI
                        updateUI();
                        document.getElementById('connectionStatus').textContent = 'Connected';
                    } else {
                        document.getElementById('connectionStatus').textContent = 'Error';
                    }
                }
            } catch (error) {
                console.error('Error processing frame:', error);
                document.getElementById('connectionStatus').textContent = 'Error';
            }

            // Continue processing
            requestAnimationFrame(processFrame);
        }

        function updateUI() {
            // Update detection count
            document.getElementById('detectionCount').textContent = state.tracks.length || 0;

            // Update inference time
            document.getElementById('inferenceTime').textContent = 
                (state.inferenceTime * 1000).toFixed(0) + 'ms';

            // Update FPS
            document.getElementById('fps').textContent = state.fps;

            // Update stats
            document.getElementById('activeTrackCount').textContent = state.tracks.length || 0;
            document.getElementById('frameCount').textContent = state.frameCount;
            document.getElementById('avgInference').textContent = 
                (state.inferenceTime * 1000).toFixed(0) + 'ms';

            // Update tracks list
            updateTracksList();
        }

        function updateTracksList() {
            const tracksList = document.getElementById('tracksList');
            
            if (!state.tracks || state.tracks.length === 0) {
                tracksList.innerHTML = '<div class="empty-message">No active tracks</div>';
                return;
            }

            tracksList.innerHTML = state.tracks.map((track, index) => `
                <div class="track-item">
                    <div class="track-item-id">Track #${index + 1}</div>
                    <div class="track-item-info">
                        ${track.confidence ? 'Confidence: ' + (track.confidence * 100).toFixed(0) + '%' : ''}
                    </div>
                </div>
            `).join('');
        }

        async function handleFileUpload() {
            const fileInput = document.getElementById('fileInput');
            const file = fileInput.files[0];

            if (!file) return;

            try {
                document.getElementById('loadingSpinner').classList.add('active');

                const reader = new FileReader();
                reader.onload = async (e) => {
                    const base64 = e.target.result.split(',')[1];

                    const response = await fetch(`${API_URL}/api/track`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            image: 'data:image/jpeg;base64,' + base64,
                            session_id: state.sessionId,
                            model_type: document.getElementById('modelSelect').value,
                            enable_tracking: document.getElementById('trackingToggle').checked
                        })
                    });

                    if (response.ok) {
                        const result = await response.json();
                        state.tracks = result.detections || [];

                        // Display result
                        const img = new Image();
                        img.onload = () => {
                            state.canvasElement.width = img.width;
                            state.canvasElement.height = img.height;
                            state.canvasContext.drawImage(img, 0, 0);

                            if (result.image) {
                                const resultImg = new Image();
                                resultImg.onload = () => {
                                    state.canvasContext.drawImage(resultImg, 0, 0);
                                    updateUI();
                                };
                                resultImg.src = 'data:image/jpeg;base64,' + result.image;
                            } else {
                                updateUI();
                            }
                        };
                        img.src = file;

                        showAlert('Image processed successfully', 'success');
                    } else {
                        showAlert('Failed to process image');
                    }
                };
                reader.readAsDataURL(file);
            } catch (error) {
                console.error('Error uploading file:', error);
                showAlert('Error uploading file: ' + error.message);
            } finally {
                document.getElementById('loadingSpinner').classList.remove('active');
            }
        }
    </script>
</body>
</html>
